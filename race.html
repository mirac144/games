<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hızlı Sürücü V6 - Hyper HDR</title>
    <style>
        /* --- Temel Ayarlar --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #87CEEB; /* Yüklenirken Gök Mavisi */
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            height: 100%;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            outline: none;
        }

        /* --- Hacker Yazısı --- */
        #hackerOverlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-10deg);
            font-size: 4rem;
            font-weight: 900;
            color: rgba(255, 0, 0, 0.8);
            pointer-events: none;
            z-index: 15;
            display: none;
            white-space: nowrap;
            text-shadow: 0 0 20px red, 2px 2px 0px black;
            animation: glitch 0.8s infinite alternate;
            width: 100%;
            text-align: center;
        }

        @keyframes glitch {
            0% { opacity: 0.5; transform: translate(-50%, -50%) rotate(-10deg) scale(1); text-shadow: 4px 4px red; }
            50% { opacity: 1; transform: translate(-51%, -49%) rotate(-10deg) scale(1.05); text-shadow: -4px -4px blue; }
            100% { opacity: 0.5; transform: translate(-49%, -51%) rotate(-10deg) scale(1); text-shadow: 4px -4px green; }
        }

        /* --- Arayüz (HUD) --- */
        #hud {
            position: absolute;
            top: 15px;
            left: 15px;
            pointer-events: none;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .hud-box {
            background: rgba(20, 20, 20, 0.8);
            padding: 8px 15px;
            border-radius: 6px;
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            border-left: 4px solid #ffcc00;
            text-shadow: 1px 1px 0 #000;
            backdrop-filter: blur(5px);
            width: fit-content;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .hud-fps { border-left-color: #00ff00; font-family: monospace; font-size: 12px; color: #ccc; }
        
        .cheat-indicator {
            color: #ff4444;
            font-size: 12px;
            margin-top: 2px;
            display: none;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 5px red;
            background: rgba(0,0,0,0.8);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid red;
        }

        /* --- Ayarlar Butonu --- */
        #settingsIcon {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            background: rgba(0,0,0,0.8);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 200;
            color: #fff;
            border: 2px solid #ffcc00;
            pointer-events: auto;
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.5);
            touch-action: manipulation;
            transition: transform 0.2s;
        }
        #settingsIcon:active { transform: scale(0.9); background: #444; }

        /* --- Menü Ekranları --- */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            background: rgba(0,0,0,0.6); /* Arka planı biraz daha şeffaf yap ki HDR görünsün */
            pointer-events: none;
            backdrop-filter: blur(3px);
        }

        .screen-box {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.95); /* Aydınlık tema menü */
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            color: #222;
            border: 4px solid #ffcc00;
            box-shadow: 0 0 60px rgba(255, 204, 0, 0.4);
            min-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        h1 { margin: 0; color: #d4a000; text-transform: uppercase; font-size: 2rem; text-shadow: 1px 1px 0px rgba(0,0,0,0.1); }
        h2 { margin: 0; color: #ff4444; text-transform: uppercase; font-size: 1.4rem; }
        p { color: #444; font-size: 1rem; margin: 0; font-weight: 500; }
        .version-text { font-size: 0.75rem; color: #0088ff; margin-top: -10px; margin-bottom: 5px; font-family: monospace; font-weight: bold;}

        .btn {
            background: linear-gradient(180deg, #ffcc00 0%, #ffaa00 100%);
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: 900;
            color: #111;
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 4px 0 #b37700;
            pointer-events: auto;
            touch-action: manipulation;
            transition: all 0.1s;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 0 0 #b37700; }

        .cheat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #eee;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        
        .cheat-btn {
            background: #bbb;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9rem;
            pointer-events: auto;
            font-weight: bold;
        }
        .cheat-btn.active { background: #2ecc71; color: #fff; box-shadow: 0 0 8px #2ecc71; }
        .cheat-btn.beta-active { background: #e74c3c; color: #fff; box-shadow: 0 0 15px red; animation: pulse 0.5s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        .fps-selector {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-bottom: 10px;
        }
        .fps-btn {
            background: #ddd;
            color: #555;
            border: 1px solid #ccc;
            padding: 8px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            pointer-events: auto;
            font-weight: bold;
        }
        .fps-btn.selected {
            background: #00a8ff;
            color: white;
            border-color: #00a8ff;
            box-shadow: 0 0 10px rgba(0, 168, 255, 0.4);
        }

        .pass-input {
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #ddd;
            background: #fff;
            color: #222;
            font-size: 1.5rem;
            text-align: center;
            width: 80%;
            margin: 0 auto;
            pointer-events: auto;
            user-select: text !important;
            -webkit-user-select: text !important;
            touch-action: pan-x pan-y !important; 
        }
        .pass-input:focus { border-color: #ffcc00; outline: none; }

        .touch-zone {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50%;
            background: rgba(0, 0, 0, 0.05); /* Aydınlık temada siyah gölge daha iyi */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.05s;
            z-index: 5;
        }
        
        #pausedText { display: none; font-size: 1.2rem; color: #d4a000; margin-top: 10px; font-weight: bold; }
        
        #loadingText {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #222;
            font-family: monospace;
            z-index: 5;
            font-weight: bold;
            font-size: 1.2rem;
            background: rgba(255,255,255,0.8);
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <div id="gameContainer">
        <div id="loadingText">HDR ASSETS LOADING...</div>
        
        <!-- HACKER YAZISI -->
        <div id="hackerOverlay">YOU HACK TO GAME</div>

        <!-- Ayarlar İkonu -->
        <div id="settingsIcon">⚙️</div>

        <!-- HUD -->
        <div id="hud">
            <div class="hud-box">SKOR: <span id="scoreDisplay">0</span></div>
            <div class="hud-box" style="border-left-color: #ff4444;">EN YÜKSEK: <span id="highScoreDisplay">0</span></div>
            <div class="hud-box hud-fps" id="fpsDisplay">FPS: 60</div>
            
            <div id="godModeText" class="cheat-indicator">★ ÖLÜMSÜZLÜK ★</div>
            <div id="speedHackText" class="cheat-indicator">⚡ 10X HIZ ⚡</div>
            <div id="betaText" class="cheat-indicator" style="background:red; color:white; border: 1px solid white;">☢ BETA 1000X ☢</div>
        </div>

        <div id="leftZone" class="touch-zone" style="left: 0;"></div>
        <div id="rightZone" class="touch-zone" style="right: 0;"></div>

        <!-- Başlangıç Menüsü -->
        <div id="startScreen" class="ui-layer">
            <div class="screen-box">
                <h1>Hızlı Sürücü V6</h1>
                <div class="version-text">Hyper HDR - Ray Tracing Enabled</div>
                <p>Mükemmel 3D Grafikler ve Yansımalar.<br>Sağ/Sol dokunarak sür.</p>
                <button class="btn" id="startBtn">OYUNA BAŞLA</button>
            </div>
        </div>

        <!-- Şifre Ekranı -->
        <div id="passwordScreen" class="ui-layer" style="display: none;">
            <div class="screen-box">
                <h2>GELİŞTİRİCİ</h2>
                <div id="pausedText">(OYUN DURAKLATILDI)</div>
                <input type="number" id="passwordInput" class="pass-input" placeholder="Şifre (3310)">
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn" style="background:#888; color:#fff; box-shadow:none;" id="cancelPassBtn">İPTAL</button>
                    <button class="btn" id="checkPassBtn">GİRİŞ</button>
                </div>
            </div>
        </div>

        <!-- Hile Menüsü -->
        <div id="cheatMenuScreen" class="ui-layer" style="display: none;">
            <div class="screen-box">
                <h2>AYARLAR & HİLE</h2>
                <div class="version-text">KERNEL ACCESS: GRANTED</div>
                
                <div style="text-align: left; width: 100%;">
                    <small style="color:#666;">MAX FPS LİMİTİ:</small>
                    <div class="fps-selector">
                        <button class="fps-btn" id="fps30">30</button>
                        <button class="fps-btn selected" id="fps60">60</button>
                        <button class="fps-btn" id="fpsMax">MAX</button>
                    </div>
                </div>

                <div class="cheat-row">
                    <span>Ölümsüzlük</span>
                    <button id="godModeBtn" class="cheat-btn">KAPALI</button>
                </div>

                <div class="cheat-row">
                    <span>Hız (10X)</span>
                    <button id="speedHackBtn" class="cheat-btn">KAPALI</button>
                </div>

                <div class="cheat-row" style="border: 2px solid #ff0000; background: #ffebeb;">
                    <span style="color:#ff0000; font-weight:900;">BETA (1000X)</span>
                    <button id="betaBtn" class="cheat-btn">KAPALI</button>
                </div>

                <button class="btn" id="closeCheatBtn">KAYDET & ÇIK</button>
            </div>
        </div>

        <!-- Oyun Bitti -->
        <div id="gameOverScreen" class="ui-layer" style="display: none;">
            <div class="screen-box">
                <h1 style="color: #ff4444;">KAZA!</h1>
                <p>Skorun: <span id="finalScore">0</span></p>
                <button class="btn" id="restartBtn">TEKRAR DENE</button>
            </div>
        </div>
    </div>

    <!-- Three.js ve Eklentiler (CDN) -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';

        // --- GLOBAL VARIABLES ---
        let gameState = 'MENU'; 
        let animationId;
        let score = 0;
        let highScore = localStorage.getItem('arabaOyunuV6High') || 0;
        let gameSpeed = 0;
        let baseSpeed = 0.8; 
        let frameCount = 0;
        let lastFpsUpdate = 0;
        let fpsLimit = 60;
        let fpsInterval = 1000 / 60;
        let then = 0;

        // Hile State
        let isGodMode = false;
        let isSpeedHack = false;
        let isBetaHack = false;
        let speedMultiplier = 1;

        // 3D Scene
        let scene, camera, renderer;
        let playerCar, roadMesh;
        let obstacles = [];
        const LANE_WIDTH = 3.5;
        const MAX_X = LANE_WIDTH * 1.5;
        let playerTargetX = 0;

        // UI Referansları
        const ui = {
            score: document.getElementById('scoreDisplay'),
            highScore: document.getElementById('highScoreDisplay'),
            fps: document.getElementById('fpsDisplay'),
            finalScore: document.getElementById('finalScore'),
            godModeText: document.getElementById('godModeText'),
            speedHackText: document.getElementById('speedHackText'),
            betaText: document.getElementById('betaText'),
            hackerOverlay: document.getElementById('hackerOverlay'),
            startScreen: document.getElementById('startScreen'),
            gameOverScreen: document.getElementById('gameOverScreen'),
            passwordScreen: document.getElementById('passwordScreen'),
            cheatMenuScreen: document.getElementById('cheatMenuScreen'),
            passwordInput: document.getElementById('passwordInput'),
            pausedText: document.getElementById('pausedText'),
            loadingText: document.getElementById('loadingText')
        };

        ui.highScore.innerText = Math.floor(highScore / 10);

        // --- 3D BAŞLATMA (HDR & RAY TRACING) ---
        function init3D() {
            scene = new THREE.Scene();
            // Varsayılan arka plan (HDR yüklenene kadar)
            scene.background = new THREE.Color(0x87CEEB);
            // Hafif sis (Ufuk çizgisini yumuşatmak için, mavi tonda)
            scene.fog = new THREE.FogExp2(0x87CEEB, 0.005);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 500);
            camera.position.set(0, 5, 12);
            camera.lookAt(0, 0, -15);

            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // HDR ve Renk Yönetimi
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2; // Parlaklığı artır
            
            document.getElementById('gameContainer').appendChild(renderer.domElement);

            // --- HDR ENVIRONMENT MAP YÜKLEME ---
            // PolyHaven'dan düşük boyutlu (1k) bir HDR haritası yüklüyoruz.
            // Bu, "Ray Tracing" etkisi yaratmak için yansımaları sağlayacak.
            new RGBELoader()
                .setPath('https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/')
                .load('kloofendal_48d_partly_cloudy_puresky_1k.hdr', function (texture) {
                    texture.mapping = THREE.EquirectangularReflectionMapping;

                    scene.background = texture;
                    scene.environment = texture; // Tüm metalik objeler bunu yansıtacak
                    
                    ui.loadingText.style.display = 'none';
                    console.log("HDR Loaded");
                }, undefined, function (err) {
                    console.error("HDR Load Fail", err);
                    // Hata olursa düz ışıklarla devam et
                    ui.loadingText.innerText = "HDR FAILED - USING STANDARD LIGHTS";
                    setTimeout(() => ui.loadingText.style.display = 'none', 1000);
                });

            // --- GÜNEŞ (Mesh + Işık) ---
            
            // 1. Görsel Güneş (Mesh)
            const sunGeo = new THREE.SphereGeometry(15, 32, 32);
            const sunMat = new THREE.MeshBasicMaterial({ color: 0xffffff }); // Saf beyaz parlayan top
            const sunMesh = new THREE.Mesh(sunGeo, sunMat);
            sunMesh.position.set(50, 100, -100);
            scene.add(sunMesh);

            // 2. Işık Kaynağı (Directional Light)
            const dirLight = new THREE.DirectionalLight(0xffffff, 2.5);
            dirLight.position.set(50, 100, -100); // Güneşle aynı konum
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048; // Kaliteli gölge
            dirLight.shadow.mapSize.height = 2048;
            dirLight.shadow.camera.near = 0.5;
            dirLight.shadow.camera.far = 500;
            dirLight.shadow.camera.left = -50;
            dirLight.shadow.camera.right = 50;
            dirLight.shadow.camera.top = 50;
            dirLight.shadow.camera.bottom = -50;
            scene.add(dirLight);

            // Dolgu Işığı (Gölgeler zifiri karanlık olmasın)
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            // --- YOL ---
            // Asfalt (Gri)
            const roadGeo = new THREE.PlaneGeometry(30, 1000);
            const roadMat = new THREE.MeshStandardMaterial({ 
                color: 0x333333, 
                roughness: 0.8, 
                metalness: 0.1 
            });
            roadMesh = new THREE.Mesh(roadGeo, roadMat);
            roadMesh.rotation.x = -Math.PI / 2;
            roadMesh.position.z = -200; // Uzun yol
            roadMesh.receiveShadow = true;
            scene.add(roadMesh);

            // Oyuncu Arabası
            playerCar = createCar(0x3498db, true);
            playerCar.position.set(0, 0, 0);
            scene.add(playerCar);

            window.addEventListener('resize', onWindowResize, false);
        }

        // --- ARABA OLUŞTURMA (RAY TRACING MATERYALLERİ) ---
        function createCar(colorHex, isPlayer) {
            const carGroup = new THREE.Group();

            // ABARTILI METALİK MATERYAL (Ray Tracing Hissi)
            const bodyMat = new THREE.MeshPhysicalMaterial({
                color: colorHex,
                metalness: 1.0,  // Tam metal
                roughness: 0.15, // Çok az pürüz (ayna gibi)
                clearcoat: 1.0,  // Cila katmanı
                clearcoatRoughness: 0.05,
                envMapIntensity: 2.0 // Yansımayı patlat
            });

            // Alt Gövde
            const mainBody = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.6, 4.2), bodyMat);
            mainBody.position.y = 0.6;
            mainBody.castShadow = true;
            mainBody.receiveShadow = true;
            carGroup.add(mainBody);

            // Cam/Kabin (Koyu Cam)
            const cabinMat = new THREE.MeshPhysicalMaterial({
                color: 0x111111,
                metalness: 0.9,
                roughness: 0.0,
                transmission: 0.2, // Hafif şeffaf
                thickness: 1.0
            });
            const cabin = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.5, 2.2), cabinMat);
            cabin.position.y = 1.15;
            cabin.position.z = -0.3;
            cabin.castShadow = true;
            carGroup.add(cabin);

            // Tekerlekler
            const wheelGeo = new THREE.CylinderGeometry(0.35, 0.35, 0.25, 24);
            const wheelMat = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.8 });
            wheelGeo.rotateZ(Math.PI / 2);

            const w1 = new THREE.Mesh(wheelGeo, wheelMat); w1.position.set(-0.95, 0.35, 1.3); carGroup.add(w1);
            const w2 = new THREE.Mesh(wheelGeo, wheelMat); w2.position.set(0.95, 0.35, 1.3); carGroup.add(w2);
            const w3 = new THREE.Mesh(wheelGeo, wheelMat); w3.position.set(-0.95, 0.35, -1.3); carGroup.add(w3);
            const w4 = new THREE.Mesh(wheelGeo, wheelMat); w4.position.set(0.95, 0.35, -1.3); carGroup.add(w4);

            // Işıklar
            if (isPlayer) {
                // Farlar (Emissive - Parlayan)
                const lightGeo = new THREE.BoxGeometry(0.4, 0.15, 0.1);
                const lightMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
                const l1 = new THREE.Mesh(lightGeo, lightMat); l1.position.set(-0.6, 0.7, -2.1); carGroup.add(l1);
                const l2 = new THREE.Mesh(lightGeo, lightMat); l2.position.set(0.6, 0.7, -2.1); carGroup.add(l2);
                
                // Spot (Yeri aydınlatsın)
                const spotL = new THREE.SpotLight(0xffffff, 5, 50, 0.6, 0.5, 1);
                spotL.position.set(0, 1, -1.8);
                spotL.target.position.set(0, 0, -20);
                carGroup.add(spotL);
                carGroup.add(spotL.target);
            } else {
                // Stop Lambaları
                const tailGeo = new THREE.BoxGeometry(0.4, 0.15, 0.1);
                const tailMat = new THREE.MeshBasicMaterial({ color: 0xff0000 });
                const t1 = new THREE.Mesh(tailGeo, tailMat); t1.position.set(-0.6, 0.7, 2.1); carGroup.add(t1);
                const t2 = new THREE.Mesh(tailGeo, tailMat); t2.position.set(0.6, 0.7, 2.1); carGroup.add(t2);
            }
            return carGroup;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- OYUN MANTIĞI ---
        
        function spawnObstacle() {
            const randomX = (Math.random() * (MAX_X * 2)) - MAX_X;
            // Canlı renkler
            const colors = [0xff0000, 0x00ff00, 0xffff00, 0xff00ff, 0xe67e22];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            const enemy = createCar(color, false);
            enemy.position.set(randomX, 0, -150); // Uzaktan gel
            enemy.userData = { speedOffset: (Math.random() - 0.5) * 0.3 };
            scene.add(enemy);
            obstacles.push(enemy);
        }

        function updateGame() {
            let scoreIncrement = 1;
            if (isSpeedHack) scoreIncrement = 5;
            if (isBetaHack) scoreIncrement = 50;
            score += scoreIncrement;

            if (speedMultiplier === 1 && score % 600 === 0) gameSpeed += 0.1;

            // Oyuncu Hareketi (Lerp)
            playerCar.position.x += (playerTargetX - playerCar.position.x) * 0.1;
            playerCar.rotation.z = (playerTargetX - playerCar.position.x) * -0.1; 
            playerCar.rotation.y = (playerTargetX - playerCar.position.x) * -0.05; // Hafif dönerken yönelme

            // Sınırlar
            if(playerCar.position.x > MAX_X) playerCar.position.x = MAX_X;
            if(playerCar.position.x < -MAX_X) playerCar.position.x = -MAX_X;

            let currentSpeed = (baseSpeed + (gameSpeed * 0.1)) * speedMultiplier;
            
            // Spawn
            let spawnChance = (currentSpeed * 1.5); 
            if (isBetaHack) spawnChance = 10; 

            if (Math.random() * 100 < spawnChance) {
                let safe = true;
                if(obstacles.length > 0) {
                     const last = obstacles[obstacles.length - 1];
                     if(last.position.z < -60) safe = false; 
                }
                if(safe) spawnObstacle();
            }

            // Engeller
            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obs = obstacles[i];
                obs.position.z += currentSpeed + (obs.userData.speedOffset || 0);

                // Collision
                if (!isGodMode) {
                    const dx = Math.abs(playerCar.position.x - obs.position.x);
                    const dz = Math.abs(playerCar.position.z - obs.position.z);
                    if (dx < 1.6 && dz < 3.8) {
                        gameOver();
                    }
                }

                if (obs.position.z > 20) {
                    scene.remove(obs);
                    obstacles.splice(i, 1);
                }
            }
            ui.score.innerText = Math.floor(score / 10);
        }

        function animate(now) {
            animationId = requestAnimationFrame(animate);

            if (gameState === 'PLAYING') {
                let elapsed = now - then;
                if (elapsed > fpsInterval) {
                    then = now - (elapsed % fpsInterval);
                    updateFPS(now);
                    updateGame();
                    renderer.render(scene, camera);
                }
            } else if (gameState === 'PAUSED') {
                 renderer.render(scene, camera);
            }
        }

        // --- KONTROL & BUTONLAR ---
        
        function startGame() {
            if (gameState === 'PLAYING') return;
            gameState = 'PLAYING';
            ui.startScreen.style.display = 'none';
            ui.gameOverScreen.style.display = 'none';
            resetGame();
            then = performance.now();
            animate(performance.now());
        }

        function resetGame() {
            playerTargetX = 0;
            playerCar.position.set(0, 0, 0);
            playerCar.rotation.set(0, 0, 0);

            obstacles.forEach(obs => scene.remove(obs));
            obstacles = [];

            score = 0;
            gameSpeed = 0;
            speedMultiplier = 1;
            updateCheatLogic();
        }

        function gameOver() {
            gameState = 'GAMEOVER';
            cancelAnimationFrame(animationId);
            let final = Math.floor(score / 10);
            ui.finalScore.innerText = final;
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('arabaOyunuV6High', highScore);
                ui.highScore.innerText = Math.floor(highScore / 10);
            }
            ui.gameOverScreen.style.display = 'flex';
        }

        function updateFPS(now) {
            frameCount++;
            if (now - lastFpsUpdate >= 1000) {
                ui.fps.innerText = "FPS: " + frameCount;
                frameCount = 0;
                lastFpsUpdate = now;
            }
        }

        // Event Listeners
        document.getElementById('startBtn').addEventListener('click', startGame);
        document.getElementById('restartBtn').addEventListener('click', startGame);
        document.getElementById('startBtn').addEventListener('touchend', (e) => { e.preventDefault(); startGame(); });
        document.getElementById('restartBtn').addEventListener('touchend', (e) => { e.preventDefault(); startGame(); });

        let isPressingLeft = false;
        let isPressingRight = false;

        const handleTouch = (e) => {
            if (gameState !== 'PLAYING') return;
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.closest('.screen-box') || e.target.id === 'settingsIcon') return;

            e.preventDefault();
            let x = e.touches ? e.touches[0].clientX : e.clientX;
            
            if (x < window.innerWidth / 2) {
                isPressingLeft = true;
                isPressingRight = false;
                document.getElementById('leftZone').style.opacity = '1';
                document.getElementById('rightZone').style.opacity = '0';
            } else {
                isPressingLeft = false;
                isPressingRight = true;
                document.getElementById('leftZone').style.opacity = '0';
                document.getElementById('rightZone').style.opacity = '1';
            }
        };

        const stopTouch = () => {
            isPressingLeft = false;
            isPressingRight = false;
            document.getElementById('leftZone').style.opacity = '0';
            document.getElementById('rightZone').style.opacity = '0';
        };

        window.addEventListener('touchstart', handleTouch, {passive: false});
        window.addEventListener('touchend', stopTouch);
        window.addEventListener('mousedown', handleTouch);
        window.addEventListener('mouseup', stopTouch);

        setInterval(() => {
            if(gameState === 'PLAYING') {
                const moveSpeed = 0.25;
                if(isPressingLeft) playerTargetX -= moveSpeed;
                if(isPressingRight) playerTargetX += moveSpeed;
                if(playerTargetX < -MAX_X) playerTargetX = -MAX_X;
                if(playerTargetX > MAX_X) playerTargetX = MAX_X;
            }
        }, 16);

        // Menüler & Şifre (3310)
        const settingsIcon = document.getElementById('settingsIcon');
        settingsIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            if(gameState === 'PLAYING') {
                gameState = 'PAUSED';
                ui.pausedText.style.display = 'block';
            }
            ui.passwordScreen.style.display = 'flex';
            ui.passwordInput.value = '';
            setTimeout(() => ui.passwordInput.focus(), 100);
        });

        document.getElementById('checkPassBtn').addEventListener('click', () => {
            if(ui.passwordInput.value === '3310') { // ŞİFRE BURADA DEĞİŞTİ
                ui.passwordScreen.style.display = 'none';
                ui.cheatMenuScreen.style.display = 'flex';
                updateCheatUI();
            } else {
                alert('Erişim Reddedildi: 3310');
            }
        });

        document.getElementById('cancelPassBtn').addEventListener('click', closeMenus);
        document.getElementById('closeCheatBtn').addEventListener('click', closeMenus);

        function closeMenus() {
            ui.passwordScreen.style.display = 'none';
            ui.cheatMenuScreen.style.display = 'none';
            if(gameState === 'PAUSED') {
                gameState = 'PLAYING';
                ui.pausedText.style.display = 'none';
            }
        }

        // Hile Butonları
        document.getElementById('godModeBtn').addEventListener('click', () => { isGodMode = !isGodMode; updateCheatUI(); });
        document.getElementById('speedHackBtn').addEventListener('click', () => { 
            isSpeedHack = !isSpeedHack; 
            if(isSpeedHack) isBetaHack = false; 
            updateCheatLogic(); updateCheatUI(); 
        });
        document.getElementById('betaBtn').addEventListener('click', () => { 
            isBetaHack = !isBetaHack; 
            if(isBetaHack) isSpeedHack = false; 
            updateCheatLogic(); updateCheatUI(); 
        });

        function updateCheatLogic() {
            if (isBetaHack) speedMultiplier = 1000;
            else if (isSpeedHack) speedMultiplier = 10;
            else speedMultiplier = 1;
        }

        function updateCheatUI() {
            const btnGod = document.getElementById('godModeBtn');
            btnGod.innerText = isGodMode ? "AÇIK" : "KAPALI";
            btnGod.className = isGodMode ? "cheat-btn active" : "cheat-btn";
            ui.godModeText.style.display = isGodMode ? "block" : "none";

            const btnSpeed = document.getElementById('speedHackBtn');
            btnSpeed.innerText = isSpeedHack ? "AÇIK" : "KAPALI";
            btnSpeed.className = isSpeedHack ? "cheat-btn active" : "cheat-btn";
            ui.speedHackText.style.display = isSpeedHack ? "block" : "none";

            const btnBeta = document.getElementById('betaBtn');
            btnBeta.innerText = isBetaHack ? "AÇIK" : "KAPALI";
            btnBeta.className = isBetaHack ? "cheat-btn beta-active" : "cheat-btn";
            ui.betaText.style.display = isBetaHack ? "block" : "none";

            if(isGodMode || isSpeedHack || isBetaHack) {
                ui.hackerOverlay.style.display = 'block';
            } else {
                ui.hackerOverlay.style.display = 'none';
            }
        }
        
        document.getElementById('fps30').addEventListener('click', () => setFps(30));
        document.getElementById('fps60').addEventListener('click', () => setFps(60));
        document.getElementById('fpsMax').addEventListener('click', () => setFps('MAX'));

        function setFps(val) {
            if (val === 'MAX') { fpsLimit = 144; fpsInterval = 1000 / 144; } 
            else { fpsLimit = val; fpsInterval = 1000 / val; }
            document.querySelectorAll('.fps-btn').forEach(b => b.classList.remove('selected'));
            if(val === 30) document.getElementById('fps30').classList.add('selected');
            if(val === 60) document.getElementById('fps60').classList.add('selected');
            if(val === 'MAX') document.getElementById('fpsMax').classList.add('selected');
        }

        init3D();
    </script>
</body>
</html>

